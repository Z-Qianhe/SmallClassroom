<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频详情</title>
    <link rel="stylesheet" href="http://at.alicdn.com/t/font_2384888_ojge9md3tr.css">
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/videoDetail.css">
    <link rel="stylesheet" href="../css/index.css">
    <script src="../js/vue-v2.6.10.js"></script>
    <script src="../js/axios-0.18.0.js"></script>
</head>

<body>
    <div id="app">
        <!-- 导航菜单 -->
        <nav>
            <div class="main">
                <img src="../img/public/logo.png" alt="" class="logo">
                <ul>
                    <li><a href="../index.html">首页</a></li>
                    <li class="check"><a href="online.html">全部课程</a></li>
                    <li><a href="javascript:;">在线练习</a></li>
                    <li><a href="javascript:;">精品课程</a></li>
                </ul>
                <div class="search">
                    <div class="left">课程<i class="iconfont icon-down"></i>
                    </div>
                    <input type="text" placeholder="搜索感兴趣的内容">
                    <img src="../img/public/search.png" alt="">
                </div>

                <div class="login" v-if="login_flag">
                    <a href="../pages/loginAndRegister/login.html">登陆</a>
                    /
                    <a href="../pages/loginAndRegister/register.html">注册</a>
                </div>
                <div class="user" v-else>
                    <img src="../img/login/user.png" alt="">
                    <div class="userlist">
                        <ul>
                            <li>{{user.name}}</li>
                            <a href="../pages/course.html">
                                <li>课程中心</li>
                            </a>
                            <li>订单中心</li>
                            <li>资金管理</li>
                            <li>个人中心</li>
                            <li class="out" @click="logout">退出登陆</li>
                        </ul>
                    </div>
                </div>

            </div>
        </nav>
        <div class="all">
            <div class="crumbs">
                <span>首页</span>
                <span>></span>
                <span>同步课堂</span>
                <span>></span>
                <span>视频详情</span>
            </div>
        </div>
        <!-- 主体内容 -->
        <main>
            <div class="classDetail">
                <div class="left">
                    <video :src="'/uploadFile/'+course.courseVideo" controls></video>
                </div>
                <div class="right">
                    <p class="title">{{course.courseName}}</p>
                    <ul>
                        <li>课程名称:{{course.courseName}}</li>
                        <li>发布日期:{{course.createTime}}</li>
                        <li>开课时间:2020-02-20</li>
                        <li>距报名截止仅剩</li>
                        <li>
                            <span>12</span>天
                            <span>23</span>时
                            <span>32</span>分
                            <span>45</span>秒
                        </li>
                        <li class="price" v-if="flag3">
                            <span>¥{{Math.floor(course.coursePrice)}}</span>
                            <span><a :href="'videoPlay.html?cid='+course.cid">课程学习</a></span>
                        </li>
                        <li class="sale" v-else>
                            <!--预留 点击购买的方法-->
                            <span @click="buy(Math.floor(course.coursePrice))" > 个人¥{{Math.floor(course.coursePrice)}}</span>
                            <span @click="buy(Math.floor(course.coursePrice*0.8))">拼团¥{{Math.floor(course.coursePrice*0.8)}}</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row title">
                <span @click="showList" :class="{active:flag2}">课程目录</span>
                <span @click="showContent" :class="{active:!flag2}">课程详情</span>
            </div>
            <div class="classlist active" v-if="flag2">
                <div class="content">
                    <div class="detail" v-for="(value,key) in courseDeatil">
                        <p class="title">{{key}}</p>
                        <ul class="active">
                            <li v-for="cd in value">
                                <p>
                                    <i class="iconfont icon-bofang"></i>
                                    <span>{{cd.name}}</span>
                                </p>
                                <p>
                                    <span>{{cd.startData}}开播</span>
                                    <span class="start">播放视频</span>
                                </p>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="bottom">
                    <span class="seeAll">小优课堂开课啦</span>
                </div>
            </div>
            <div class="classlist" v-else>
                <img :src="'/uploadFile/'+course.courseImage" alt="">
            </div>
        </main>

        <footer>
            <div class="cont">
                <div class="main">
                    <p>
                        首页 | 关于我们 | 加入我们 | 合作专区 | 联系我们 | AI开放平台 | 意见反馈 | 漏洞提交 | 隐私政策 | 版权声明 | 反盗链声明 | 网上有害信息举报 | 备案公示 |
                        营业执照
                        | 教师资格证公示
                    </p>
                    <p>
                        京ICP备10218183号-1 京ICP证161188号 七易时代科技有限公司 | 地址：北京市昌平区慧聪采购园 | 电话：010-66666666 | 京公网安备
                        01010102002533号
                    </p>
                    <p>
                        京网文〔2018〕4086-308号 | 网络文化经营许可证：沪网文[2018]4086-308号 | 增值电信业务经营许可证：京B2-20150021 |
                    </p>
                    <p>在线教育许可证：小优课堂经营许可证20188008号 | 互联网教育服务资格证书：(京)-经营性-2018-0011 |</p>
                </div>
            </div>
        </footer>
    </div>
</body>
<script>
    new Vue({
        el: "#app",
        data: {
            login_flag : true,
            user : '',
            course : '',
            courseDeatil : '',  //课程目录数据
            flag2 : true,   //定义课程详情和课程目录切换
            flag3 : false   //定义是否购买  默认是否
        },
        methods: {
            initParams() {
                //从vue自己的session域对象中获取数据
                var user =  sessionStorage.getItem("user");
                //判断当前页面中用户是否登陆了
                if(user == null || user == ""){
                    //证明当前的用户为登陆 展示登陆和注册的div
                    this.login_flag = true;
                }else {
                    //证明当前用户已经登陆 展示用户状态的div
                    this.login_flag = false;
                    //展示用户数据 本身登陆成功后将数据转化为json字符串，我们如果要在页面中展示数据需要将字符串转化为json对象
                    this.user = JSON.parse(user);
                }
            },
            logout(){
                //用户退出的方法 异步调用后台退出的方法
                axios.post("/user/loginOut").then(res => {
                    //删除vue会话数据
                    sessionStorage.removeItem("user");
                //跳转到登陆页面
                location.href = "/";
            })
            },
            getCourseByCid(){
                //获取当前页面的url地址
                // 就相当于得到当前url地址的字符串  http://localhost:8080/xiaou/pages/videoDetail.html?cid=4
                var path = location.href;
                //通过字符串截取  将参数截取出来
                var cid = path.substring(path.lastIndexOf("=")+1);
                //根据课程的cid  获取课程的具体信息
                axios({
                    url:'/course/getCourseByCid?cid='+cid,
                    method:'post'
                }).then(res=>{
                    //将课程数据赋值到vue中定义的课程数据
                    this.course = res.data.data;
                })
            },
            getCourseDetailByCid(){
//获取当前页面的url地址 就相当于得到当前url地址的字符串
                //http://localhost:8080/xiaou/pages/videoDetail.html?cid=4
                    var path = location.href;
//通过字符串截取 将参数截取出来
                var cid = path.substring(path.lastIndexOf("=") + 1);
//异步后台获取对应的数据
                axios({
                    url : '/coursedetail/getCourseDetailByCid?cid='+cid,
                    method: 'post'
                }).then( res => {
//将后台传递的详情数据复制给vue数据
                    this.courseDeatil = res.data.data;
            })
            },

            showList(){
                //点击切换到目录展示   将flag2设置为true就可以
                this.flag2 = true;
            },
            showContent(){
                //点击切换到课程详情   将flag2设置为flase就可以
                this.flag2 = false;
            },
            buy(price){
                //用户登陆后才可以进行课程购买 判断当前用户是否登陆
                if (this.user == null || this.user == ""){
                    //如果用户没有登陆 弹窗跳转到登陆页面
                    alert("请先登录");
                    //跳转到登陆页面
                    location.href = "loginAndRegister/login.html";
                }else {
                    //创建一个时间戳 年月日时分秒毫秒 用来做订单编号
                    //创建一个时间类
                    var vNow = new Date();
                    //创建一个存放时间戳的变量
                    var sNow = "";
                    //在时间戳中拼接年 月 日 。。。。
                    sNow += String(vNow.getFullYear());
                    sNow += String(vNow.getMonth() + 1);
                    sNow += String(vNow.getDate());
                    sNow += String(vNow.getHours());
                    sNow += String(vNow.getMinutes());
                    sNow += String(vNow.getSeconds());
                    sNow += String(vNow.getMilliseconds());
                    //为了和支付接口名称相同 我们创建几个变量用来传递数据
                    var wIDout_trade_no = sNow; //订单编号
                    var wIDsubject = this.course.courseName; //订单名称
                    var wIDtotal_amount = price; //付款金额
                    //使用url进行地址跳转
                    location.href = "http://localhost:8080/pay/course?wIDout_trade_no="+wIDout_trade_no
                        +"&wIDsubject="+wIDsubject+"&wIDtotal_amount="+wIDtotal_amount
                        +"&cid="+this.course.cid+"&uid="+this.user.uid;
                }
            },
            buyOrStudy(){
                //获取当前页面的url地址 就相当于得到当前url地址的字符串
                // http://localhost:8080/xiaou/pages/videoDetail.html?cid=4
                var path = location.href;
                //通过字符串截取 将参数截取出来
                var cid = path.substring(path.lastIndexOf("=") + 1);
                //查看当前用户是否登陆
                if(!(this.user == null || this.user == "")){
                    //根据用户的uid和课程的cid后台进行查询 查看当前用户是否购买过这个课程
                    axios({
                        url:'/course-user/buyOrStudy?cid='+cid+'&uid='+this.user.uid,
                        method:'post'
                    }).then( res => {
                    //根据后台返回的结果 设置购买vue变量
                        this.flag3 = res.data.flag;
                })
                }

            }
        },
        created() {
            //初始化判断用户登陆的方法
            this.initParams();
            //调用根据课程id获取课程信息的方法
            this.getCourseByCid();
            //调用根据课程cid获取课程详情目录的方法
            this.getCourseDetailByCid();
            //判断当前课程登陆的用户是否购买
            this.buyOrStudy();
        }

    })
</script>

</html>